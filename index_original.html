<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF çŸ¢é‡æˆªå–å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
    <!-- pdf-lib ç”¨äºç”Ÿæˆå’Œåˆå¹¶PDF -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; background-color: #f0f2f5; }
        
        /* ä¾§è¾¹æ æ ·å¼ */
        #sidebar { width: 320px; background: #fff; border-right: 1px solid #ccc; display: flex; flex-direction: column; padding: 10px; box-shadow: 2px 0 5px rgba(0,0,0,0.05); z-index: 10; }
        .panel { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .panel:last-child { border-bottom: none; }
        h3 { margin: 0 0 10px 0; font-size: 16px; color: #333; }
        button { cursor: pointer; padding: 8px 12px; margin: 3px; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 13px; transition: background 0.2s; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #545b62; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #c82333; }
        input[type="text"], input[type="number"] { padding: 6px; border: 1px solid #ddd; border-radius: 4px; width: calc(100% - 16px); margin-bottom: 5px; }
        
        /* æˆªå›¾åˆ—è¡¨ */
        #captured-list { flex: 1; overflow-y: auto; background: #fafafa; border: 1px solid #eee; border-radius: 4px; padding: 5px; }
        .captured-item { position: relative; margin-bottom: 5px; border: 1px solid #ddd; padding: 8px; background: white; }
        .captured-item .info { font-size: 12px; color: #666; margin-bottom: 4px; }
        .captured-item .coords { font-size: 11px; font-family: monospace; color: #333; }
        .captured-item .remove-btn { position: absolute; top: 2px; right: 2px; background: rgba(255,0,0,0.7); color: white; border: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .captured-item canvas { width: 100%; display: block; margin-top: 5px; border: 1px solid #eee; }
        
        /* ä¸»åŒºåŸŸ */
        #main-area { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        #toolbar { min-height: 50px; background: #fff; border-bottom: 1px solid #ccc; display: flex; align-items: center; padding: 8px 20px; gap: 10px; justify-content: space-between; flex-wrap: wrap; }
        #pdf-container { flex: 1; overflow: auto; position: relative; background-color: #525659; display: flex; justify-content: center; padding: 20px; }
        
        /* PDF åŒ…è£…å™¨ */
        #page-wrapper { position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.3); line-height: 0; }
        canvas { display: block; }

        /* æˆªå›¾é€‰æ¡†æ ·å¼ */
        #crop-box {
            position: absolute;
            border: 2px dashed #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
            cursor: move;
            display: none;
            box-sizing: border-box;
            z-index: 100;
        }
        
        /* æ‹–æ‹½æ‰‹æŸ„ */
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #e74c3c;
            border: 1px solid #fff;
            z-index: 101;
        }
        .rh-n { top: -5px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }
        .rh-s { bottom: -5px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }
        .rh-e { top: 50%; right: -5px; transform: translateY(-50%); cursor: ew-resize; }
        .rh-w { top: 50%; left: -5px; transform: translateY(-50%); cursor: ew-resize; }
        .rh-ne { top: -5px; right: -5px; cursor: nesw-resize; }
        .rh-nw { top: -5px; left: -5px; cursor: nwse-resize; }
        .rh-se { bottom: -5px; right: -5px; cursor: nwse-resize; }
        .rh-sw { bottom: -5px; left: -5px; cursor: nesw-resize; }

        /* é¢„è§ˆå¼¹çª— */
        #preview-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #preview-content { background: #fff; max-width: 90%; max-height: 80%; overflow: auto; padding: 10px; text-align: center; }
        #preview-content canvas { max-width: 100%; height: auto; border: 1px solid #ccc; margin-bottom: 10px; }
        #preview-actions { margin-top: 10px; display: flex; gap: 10px; }

        .status-text { font-size: 12px; color: #666; margin-left: 10px; }

        /* æ–‡æœ¬å±‚æ ·å¼ */
        #text-layer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            opacity: 0.2;
            line-height: 1.0;
            z-index: 2;
        }
        #text-layer > span {
            color: transparent;
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: 0% 0%;
        }
        #text-layer .highlight {
            background-color: rgba(255, 255, 0, 0.3);
        }
        #text-layer ::selection {
            background: rgba(0, 0, 255, 0.3);
        }

        /* å·¥å…·æ ä¸­çš„é¡µç è·³è½¬è¾“å…¥æ¡† */
        .toolbar-page-jump {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .toolbar-page-jump input {
            width: 50px;
            margin: 0;
            padding: 4px;
            font-size: 12px;
        }

        /* å·¥å…·æ ä¸­çš„è¿ç»­ç¿»é¡µæ§åˆ¶ */
        .toolbar-auto-page {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .toolbar-auto-page input {
            width: 50px;
            margin: 0;
            padding: 4px;
            font-size: 12px;
        }

        /* å·¥å…·æ æŒ‰é’®å›¾æ ‡æ ·å¼ */
        .toolbar-icon-btn {
            font-size: 16px;
            padding: 6px 10px;
            min-width: 36px;
        }

        /* å·¥å…·æ åˆ†éš”çº¿ */
        .toolbar-divider {
            border-left: 1px solid #ddd;
            padding-left: 15px;
            margin-left: 0;
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 1200px) {
            #toolbar > div:first-child {
                flex-wrap: wrap;
                gap: 10px;
            }
            .toolbar-divider {
                border-left: none;
                border-top: 1px solid #ddd;
                padding-left: 0;
                padding-top: 8px;
                margin-top: 8px;
                margin-left: 0;
            }
        }

        .info-badge {
            display: inline-block;
            padding: 2px 6px;
            background: #17a2b8;
            color: white;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 5px;
        }
    </style>
</head>
<body>

<!-- ä¾§è¾¹æ  -->
<div id="sidebar">
    <div class="panel">
        <h3>1. åŠ è½½æ–‡ä»¶ <span class="info-badge">çŸ¢é‡æ¨¡å¼</span></h3>
        <input type="file" id="file-input" accept="application/pdf" />
        <p style="font-size:11px; color:#666; margin-top:5px;">ğŸ’¡ æ­¤å·¥å…·æˆªå–PDFä¸ºPDFæ ¼å¼ï¼Œä¿æŒçŸ¢é‡æ¸…æ™°åº¦</p>
    </div>

    <div class="panel">
        <h3>2. æˆªå–è®¾ç½®</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
            <button id="init-crop">æ˜¾ç¤º/éšè—æˆªå–æ¡†</button>
            <button id="lock-width-page">å®½åº¦=é¡µé¢å®½</button>
            <button id="lock-x-toggle">é”å®šXè½´(å®½)</button>
        </div>
        <p style="font-size:12px; color:#666; margin-top:5px;">é”å®šXè½´åï¼Œæ‹–æ‹½ä»…æ”¹å˜é«˜åº¦ï¼Œé€‚åˆå»é™¤é¡µçœ‰é¡µè„šã€‚</p>
        <button style="width:100%; margin-top:5px; font-weight:bold; font-size:15px;" id="capture-btn">ğŸ“„ æˆªå–é€‰ä¸­åŒºåŸŸ(PDF)</button>
    </div>

    <div class="panel" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
        <h3>3. å·²æˆªå–ç‰‡æ®µ (<span id="count-span">0</span>)</h3>
        <div id="captured-list">
            <!-- æˆªå›¾åˆ—è¡¨ -->
        </div>
    </div>

    <div class="panel">
        <h3>4. å¯¼å‡º</h3>
        <input type="text" id="filename-input" value="merged_document" placeholder="è¾“å…¥æ–‡ä»¶å" />
        <button id="preview-btn" style="width:100%; background-color: #28a745;">é¢„è§ˆå¹¶åˆå¹¶PDF</button>
        <button class="danger" id="clear-btn" style="width:100%; margin-top:5px;">æ¸…ç©ºæ‰€æœ‰æˆªå–</button>
    </div>
</div>

<!-- ä¸»åŒºåŸŸ -->
<div id="main-area">
    <div id="toolbar">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div>
                <strong>PDF è§†å›¾:</strong>
                <button class="secondary" onclick="changeZoom(0.2)">æ”¾å¤§ +</button>
                <button class="secondary" onclick="changeZoom(-0.2)">ç¼©å° -</button>
                <span class="status-text" id="zoom-level">100%</span>
            </div>
            <div class="toolbar-divider" style="display: flex; align-items: center; gap: 8px;">
                <button class="secondary toolbar-icon-btn" id="prev-page" title="ä¸Šä¸€é¡µ">â—€</button>
                <span id="page-num" style="font-size:14px; min-width: 60px; text-align: center; font-weight: 500;">0 / 0</span>
                <button class="secondary toolbar-icon-btn" id="next-page" title="ä¸‹ä¸€é¡µ">â–¶</button>
            </div>
            <div class="toolbar-page-jump toolbar-divider">
                <input type="number" id="jump-page-input" placeholder="é¡µç " min="1" />
                <button class="secondary" id="jump-page-btn" title="è·³è½¬åˆ°æŒ‡å®šé¡µ">ğŸ” è·³è½¬</button>
            </div>
            <div class="toolbar-auto-page toolbar-divider">
                <input type="number" id="auto-page-interval" value="2" min="0.5" max="10" step="0.5" placeholder="ç§’" title="ç¿»é¡µé—´éš”(ç§’)" />
                <button class="secondary" id="auto-page-toggle" title="è‡ªåŠ¨è¿ç»­ç¿»é¡µ">â¯ è¿ç»­ç¿»é¡µ</button>
            </div>
            <div class="toolbar-divider">
                <button class="secondary" id="bbox-tool-btn" title="Bounding Boxæ ‡æ³¨å·¥å…·" style="background-color: #17a2b8;">ğŸ“¦ BBoxå·¥å…·</button>
            </div>
        </div>
    </div>
    <div id="pdf-container">
        <div id="page-wrapper">
            <canvas id="pdf-canvas"></canvas>
            <div id="text-layer"></div>
            <div id="crop-box">
                <!-- 8ä¸ªæ–¹å‘çš„æ‰‹æŸ„ -->
                <div class="resize-handle rh-nw" data-dir="nw"></div>
                <div class="resize-handle rh-n"  data-dir="n"></div>
                <div class="resize-handle rh-ne" data-dir="ne"></div>
                <div class="resize-handle rh-e"  data-dir="e"></div>
                <div class="resize-handle rh-se" data-dir="se"></div>
                <div class="resize-handle rh-s"  data-dir="s"></div>
                <div class="resize-handle rh-sw" data-dir="sw"></div>
                <div class="resize-handle rh-w"  data-dir="w"></div>
            </div>
        </div>
    </div>
</div>

<!-- é¢„è§ˆå¼¹çª— -->
<div id="preview-modal">
    <div id="preview-content">
        <div id="preview-pages-container">
            <!-- é¢„è§ˆé¡µé¢å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
    <div id="preview-actions">
        <button onclick="downloadPDF()">â¬‡ï¸ ä¸‹è½½PDF</button>
        <button class="secondary" onclick="closePreview()">å…³é—­</button>
    </div>
</div>

<script>
    let pdfDoc = null;
    let pdfBytes = null; // ä¿å­˜åŸå§‹PDFæ•°æ®ç”¨äºæˆªå–
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    let scale = 1.5;
    let canvas = document.getElementById('pdf-canvas');
    let ctx = canvas.getContext('2d');
    let capturedRegions = []; // å­˜å‚¨æˆªå–çš„åŒºåŸŸä¿¡æ¯: [{pageNum, rect: {x, y, width, height}, previewCanvas}]
    let textLayerDiv = document.getElementById('text-layer');
    let currentPage = null;
    let mergedPdfBytes = null; // å­˜å‚¨åˆå¹¶åçš„PDFæ•°æ®

    // æˆªå›¾æ¡†çŠ¶æ€
    let cropBox = document.getElementById('crop-box');
    let isDragging = false;
    let isResizing = false;
    let resizeDir = '';
    let startX, startY, startLeft, startTop, startWidth, startHeight;
    let isXLocked = false;
    let isCropBoxInitialized = false;

    // è¿ç»­ç¿»é¡µçŠ¶æ€
    let autoPageInterval = null;
    let isAutoPaging = false;

    // é”®ç›˜å¿«æ·é”®çŠ¶æ€
    let keyAdjustInterval = null;
    let isKeyAdjusting = false;
    let currentAdjustDelta = 0;

    // æ¸²æŸ“é¡µé¢
    function renderPage(num) {
        pageRendering = true;
        pdfDoc.getPage(num).then(function(page) {
            currentPage = page;
            const viewport = page.getViewport({scale: scale});
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            document.getElementById('page-wrapper').style.width = viewport.width + 'px';
            document.getElementById('page-wrapper').style.height = viewport.height + 'px';
            textLayerDiv.style.width = viewport.width + 'px';
            textLayerDiv.style.height = viewport.height + 'px';

            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            const renderTask = page.render(renderContext);

            renderTask.promise.then(function() {
                renderTextLayer(page, viewport);
                
                pageRendering = false;
                document.getElementById('page-num').textContent = `${pageNum} / ${pdfDoc.numPages}`;
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
            });
        });
    }

    // æ¸²æŸ“æ–‡æœ¬å±‚
    function renderTextLayer(page, viewport) {
        textLayerDiv.innerHTML = '';
        
        page.getTextContent().then(function(textContent) {
            const textContentItems = textContent.items;
            const transform = viewport.transform;
            
            for (let i = 0; i < textContentItems.length; i++) {
                const item = textContentItems[i];
                const tx = transform[0] * item.transform[4] + transform[2] * item.transform[5] + transform[4];
                const ty = transform[1] * item.transform[4] + transform[3] * item.transform[5] + transform[5];
                const angle = Math.atan2(transform[1], transform[0]);
                const fontSize = Math.sqrt(item.transform[0] * item.transform[0] + item.transform[1] * item.transform[1]);
                
                const span = document.createElement('span');
                span.textContent = item.str;
                span.style.left = tx + 'px';
                span.style.top = ty + 'px';
                span.style.fontSize = fontSize + 'px';
                span.style.fontFamily = item.fontName;
                span.style.transform = `rotate(${angle}rad)`;
                span.style.transformOrigin = '0% 0%';
                
                textLayerDiv.appendChild(span);
            }
        }).catch(function(error) {
            console.warn('æ–‡æœ¬å±‚æ¸²æŸ“å¤±è´¥:', error);
        });
    }

    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    function onPrevPage() {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    }

    function onNextPage() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    }

    document.getElementById('prev-page').addEventListener('click', onPrevPage);
    document.getElementById('next-page').addEventListener('click', onNextPage);

    // é¡µç è·³è½¬åŠŸèƒ½
    document.getElementById('jump-page-btn').addEventListener('click', function() {
        if (!pdfDoc) return alert("è¯·å…ˆåŠ è½½ PDF");
        const targetPage = parseInt(document.getElementById('jump-page-input').value);
        if (isNaN(targetPage) || targetPage < 1 || targetPage > pdfDoc.numPages) {
            alert(`è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç  (1-${pdfDoc.numPages})`);
            return;
        }
        pageNum = targetPage;
        queueRenderPage(pageNum);
        document.getElementById('jump-page-input').value = '';
    });

    document.getElementById('jump-page-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('jump-page-btn').click();
        }
    });

    // è¿ç»­ç¿»é¡µåŠŸèƒ½
    document.getElementById('auto-page-toggle').addEventListener('click', function() {
        if (!pdfDoc) return alert("è¯·å…ˆåŠ è½½ PDF");
        
        if (isAutoPaging) {
            if (autoPageInterval) {
                clearInterval(autoPageInterval);
                autoPageInterval = null;
            }
            isAutoPaging = false;
            this.innerHTML = 'â¯ è¿ç»­ç¿»é¡µ';
            this.style.backgroundColor = '#007bff';
        } else {
            const interval = parseFloat(document.getElementById('auto-page-interval').value) || 2;
            if (interval < 0.5) {
                alert('ç¿»é¡µé—´éš”ä¸èƒ½å°äº0.5ç§’');
                return;
            }
            
            autoPageInterval = setInterval(function() {
                if (pageNum < pdfDoc.numPages) {
                    onNextPage();
                } else {
                    document.getElementById('auto-page-toggle').click();
                }
            }, interval * 1000);
            
            isAutoPaging = true;
            this.innerHTML = 'â¸ åœæ­¢ç¿»é¡µ';
            this.style.backgroundColor = '#dc3545';
        }
    });

    function changeZoom(delta) {
        if (!pdfDoc) return;
        scale += delta;
        if (scale < 0.5) scale = 0.5;
        document.getElementById('zoom-level').innerText = Math.round(scale * 100) + '%';
        renderPage(pageNum);
    }

    function adjustCropBoxBottom(delta) {
        if (!pdfDoc || cropBox.style.display === 'none') return;
        
        const currentHeight = parseInt(cropBox.style.height, 10) || cropBox.offsetHeight;
        const currentTop = cropBox.offsetTop;
        const newHeight = currentHeight + delta;
        
        if (newHeight < 10) return;
        if (currentTop + newHeight > canvas.height) {
            cropBox.style.height = (canvas.height - currentTop) + 'px';
        } else {
            cropBox.style.height = newHeight + 'px';
        }
    }

    // é”®ç›˜å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', function(e) {
        if (!pdfDoc) return;
        
        if ((e.key === ' ' || e.key === 'Spacebar') && !e.target.matches('input, textarea')) {
            e.preventDefault();
            captureSelectedArea();
            return;
        }
        
        if ((e.key === 'ArrowUp' || e.key === 'ArrowDown') && cropBox.style.display !== 'none') {
            e.preventDefault();
            
            const delta = e.key === 'ArrowUp' ? -5 : 5;
            currentAdjustDelta = delta;
            
            adjustCropBoxBottom(delta);
            
            if (!isKeyAdjusting) {
                isKeyAdjusting = true;
                setTimeout(function() {
                    if (isKeyAdjusting && currentAdjustDelta !== 0) {
                        keyAdjustInterval = setInterval(function() {
                            adjustCropBoxBottom(currentAdjustDelta);
                        }, 50);
                    }
                }, 150);
            }
            return;
        }
        
        if (e.key === 'ArrowLeft' && !e.target.matches('input, textarea')) {
            e.preventDefault();
            onPrevPage();
        } else if (e.key === 'ArrowRight' && !e.target.matches('input, textarea')) {
            e.preventDefault();
            onNextPage();
        } else if (e.key === 'PageUp' && !e.target.matches('input, textarea')) {
            e.preventDefault();
            onPrevPage();
        } else if (e.key === 'PageDown' && !e.target.matches('input, textarea')) {
            e.preventDefault();
            onNextPage();
        }
    });

    document.addEventListener('keyup', function(e) {
        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
            if (keyAdjustInterval) {
                clearInterval(keyAdjustInterval);
                keyAdjustInterval = null;
            }
            isKeyAdjusting = false;
            currentAdjustDelta = 0;
        }
    });

    // ================= æˆªå›¾æ¡†é€»è¾‘ =================

    function initCropBox() {
        if (!pdfDoc) return alert("è¯·å…ˆåŠ è½½ PDF");
        cropBox.style.left = '50px';
        cropBox.style.top = '50px';
        cropBox.style.width = (canvas.width - 100) + 'px';
        cropBox.style.height = (canvas.height / 3) + 'px';
        isXLocked = false;
        isCropBoxInitialized = true;
        updateHandleVisibility();
    }

    function toggleCropBox() {
        if (!pdfDoc) return alert("è¯·å…ˆåŠ è½½ PDF");
        
        const btn = document.getElementById('init-crop');
        const isCurrentlyVisible = cropBox.style.display === 'block';
        
        if (isCurrentlyVisible) {
            cropBox.style.display = 'none';
            btn.style.backgroundColor = '#007bff';
        } else {
            if (!isCropBoxInitialized) {
                initCropBox();
            }
            cropBox.style.display = 'block';
            btn.style.backgroundColor = '#28a745';
        }
    }

    document.getElementById('init-crop').addEventListener('click', toggleCropBox);

    document.getElementById('lock-width-page').addEventListener('click', function() {
        if (!pdfDoc) return;
        cropBox.style.left = '0px';
        cropBox.style.width = canvas.width + 'px';
        isXLocked = true;
        updateHandleVisibility();
        updateLockButtonText();
    });

    document.getElementById('lock-x-toggle').addEventListener('click', function() {
        isXLocked = !isXLocked;
        updateHandleVisibility();
        updateLockButtonText();
    });

    function updateLockButtonText() {
        const btn = document.getElementById('lock-x-toggle');
        btn.textContent = isXLocked ? "å·²é”å®šXè½´(è§£é”)" : "é”å®šXè½´(å®½)";
        btn.style.backgroundColor = isXLocked ? "#28a745" : "#007bff";
    }

    function updateHandleVisibility() {
        const handles = cropBox.querySelectorAll('.resize-handle');
        handles.forEach(h => {
            const dir = h.dataset.dir;
            if (isXLocked) {
                if (['e', 'w', 'ne', 'nw', 'se', 'sw'].includes(dir)) {
                    h.style.display = 'none';
                } else {
                    h.style.display = 'block';
                }
            } else {
                h.style.display = 'block';
            }
        });
        cropBox.style.cursor = isXLocked ? 'ns-resize' : 'move';
    }

    // é¼ æ ‡äº‹ä»¶å¤„ç†
    const pageWrapper = document.getElementById('page-wrapper');

    pageWrapper.addEventListener('mousedown', function(e) {
        if (e.target.classList.contains('resize-handle')) {
            isResizing = true;
            resizeDir = e.target.dataset.dir;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = parseInt(document.defaultView.getComputedStyle(cropBox).width, 10);
            startHeight = parseInt(document.defaultView.getComputedStyle(cropBox).height, 10);
            startLeft = cropBox.offsetLeft;
            startTop = cropBox.offsetTop;
            e.stopPropagation();
            e.preventDefault();
        } else if (e.target === cropBox) {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startLeft = cropBox.offsetLeft;
            startTop = cropBox.offsetTop;
            e.stopPropagation();
            e.preventDefault();
        }
    });

    window.addEventListener('mousemove', function(e) {
        if (isDragging) {
            let dx = e.clientX - startX;
            let dy = e.clientY - startY;
            
            let newTop = startTop + dy;
            if (newTop < 0) newTop = 0;
            if (newTop + cropBox.offsetHeight > canvas.height) newTop = canvas.height - cropBox.offsetHeight;
            cropBox.style.top = newTop + 'px';

            if (!isXLocked) {
                let newLeft = startLeft + dx;
                if (newLeft < 0) newLeft = 0;
                if (newLeft + cropBox.offsetWidth > canvas.width) newLeft = canvas.width - cropBox.offsetWidth;
                cropBox.style.left = newLeft + 'px';
            }
        } else if (isResizing) {
            let dx = e.clientX - startX;
            let dy = e.clientY - startY;

            if (resizeDir.includes('s')) {
                let newH = startHeight + dy;
                if (newH > 10) cropBox.style.height = newH + 'px';
            }
            if (resizeDir.includes('n')) {
                let newH = startHeight - dy;
                let newTop = startTop + dy;
                if (newH > 10 && newTop >= 0) {
                    cropBox.style.height = newH + 'px';
                    cropBox.style.top = newTop + 'px';
                }
            }

            if (!isXLocked) {
                if (resizeDir.includes('e')) {
                    let newW = startWidth + dx;
                    if (newW > 10) cropBox.style.width = newW + 'px';
                }
                if (resizeDir.includes('w')) {
                    let newW = startWidth - dx;
                    let newLeft = startLeft + dx;
                    if (newW > 10 && newLeft >= 0) {
                        cropBox.style.width = newW + 'px';
                        cropBox.style.left = newLeft + 'px';
                    }
                }
            }
        }
    });

    window.addEventListener('mouseup', function() {
        isDragging = false;
        isResizing = false;
    });

    // ================= PDFæˆªå–ä¸åˆå¹¶ =================

    async function captureSelectedArea() {
        if (!pdfDoc || cropBox.style.display === 'none' || !pdfBytes) return;

        const rect = {
            x: cropBox.offsetLeft,
            y: cropBox.offsetTop,
            w: cropBox.offsetWidth,
            h: cropBox.offsetHeight
        };

        // è½¬æ¢ä¸ºPDFåæ ‡ç³»ï¼ˆPDFåæ ‡åŸç‚¹åœ¨å·¦ä¸‹è§’ï¼Œéœ€è¦è½¬æ¢ï¼‰
        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({scale: scale});
        
        // Canvasåæ ‡è½¬æ¢ä¸ºPDFåæ ‡ï¼ˆç‚¹ï¼‰
        const pdfRect = {
            x: rect.x / viewport.scale,
            y: (viewport.height - rect.y - rect.h) / viewport.scale, // Yè½´ç¿»è½¬
            width: rect.w / viewport.scale,
            height: rect.h / viewport.scale
        };

        console.log('æˆªå–åŒºåŸŸ - Canvasåæ ‡:', rect);
        console.log('æˆªå–åŒºåŸŸ - PDFåæ ‡:', pdfRect);

        // åˆ›å»ºé¢„è§ˆCanvas
        const previewCanvas = document.createElement('canvas');
        previewCanvas.width = rect.w;
        previewCanvas.height = rect.h;
        const previewCtx = previewCanvas.getContext('2d');
        previewCtx.drawImage(canvas, rect.x, rect.y, rect.w, rect.h, 0, 0, rect.w, rect.h);

        // ä¿å­˜æˆªå–ä¿¡æ¯
        capturedRegions.push({
            pageNum: pageNum,
            rect: pdfRect,
            previewCanvas: previewCanvas,
            displayRect: rect
        });
        
        updateCapturedList();
        
        // è§†è§‰åé¦ˆ
        const originalBorder = cropBox.style.borderColor;
        cropBox.style.borderColor = '#28a745';
        setTimeout(() => { cropBox.style.borderColor = originalBorder; }, 200);
    }

    document.getElementById('capture-btn').addEventListener('click', captureSelectedArea);

    function updateCapturedList() {
        const list = document.getElementById('captured-list');
        const countSpan = document.getElementById('count-span');
        list.innerHTML = '';
        countSpan.innerText = capturedRegions.length;

        capturedRegions.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'captured-item';
            
            const info = document.createElement('div');
            info.className = 'info';
            info.textContent = `ç‰‡æ®µ #${index + 1} - é¡µé¢ ${item.pageNum}`;
            
            const coords = document.createElement('div');
            coords.className = 'coords';
            coords.textContent = `PDFåæ ‡: [${Math.round(item.rect.x)}, ${Math.round(item.rect.y)}, ${Math.round(item.rect.width)}Ã—${Math.round(item.rect.height)}]`;
            
            const btn = document.createElement('button');
            btn.className = 'remove-btn';
            btn.innerHTML = 'Ã—';
            btn.onclick = () => {
                capturedRegions.splice(index, 1);
                updateCapturedList();
            };

            div.appendChild(info);
            div.appendChild(coords);
            div.appendChild(item.previewCanvas);
            div.appendChild(btn);
            list.appendChild(div);
        });
        
        requestAnimationFrame(() => {
            list.scrollTop = list.scrollHeight;
        });
    }

    document.getElementById('clear-btn').addEventListener('click', () => {
        if(confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æˆªå–å—ï¼Ÿ")) {
            capturedRegions = [];
            updateCapturedList();
        }
    });

    // åˆå¹¶PDF
    document.getElementById('preview-btn').addEventListener('click', async function() {
        if (capturedRegions.length === 0) return alert("è¿˜æ²¡æœ‰æˆªå–ä»»ä½•åŒºåŸŸ");
        if (!pdfBytes) return alert("PDFæ•°æ®ä¸å¯ç”¨");

        try {
            console.log('å¼€å§‹åˆå¹¶PDFï¼Œå…±', capturedRegions.length, 'ä¸ªåŒºåŸŸ');
            
            // ä½¿ç”¨ pdf-lib åˆ›å»ºæ–°PDF
            const { PDFDocument } = PDFLib;
            const sourcePdf = await PDFDocument.load(pdfBytes);
            const newPdf = await PDFDocument.create();

            // ä¸ºæ¯ä¸ªæˆªå–åŒºåŸŸåˆ›å»ºä¸€ä¸ªæ–°é¡µé¢
            for (let i = 0; i < capturedRegions.length; i++) {
                const region = capturedRegions[i];
                console.log(`å¤„ç†åŒºåŸŸ ${i + 1}/${capturedRegions.length}:`, region);

                // è·å–æºé¡µé¢
                const sourcePage = sourcePdf.getPage(region.pageNum - 1);
                const { width: pageWidth, height: pageHeight } = sourcePage.getSize();
                
                console.log('æºé¡µé¢å°ºå¯¸:', pageWidth, 'x', pageHeight);
                console.log('æˆªå–åŒºåŸŸ:', region.rect);
                
                // åˆ›å»ºæ–°é¡µé¢ï¼Œå°ºå¯¸ä¸ºæˆªå–åŒºåŸŸçš„å°ºå¯¸
                const newPage = newPdf.addPage([region.rect.width, region.rect.height]);
                
                // åµŒå…¥æºé¡µé¢
                const embeddedPage = await newPdf.embedPage(sourcePage);
                
                // åœ¨æ–°é¡µé¢ä¸Šç»˜åˆ¶åµŒå…¥çš„é¡µé¢ï¼Œé€šè¿‡åç§»æ¥å®ç°è£å‰ªæ•ˆæœ
                // PDFåæ ‡ç³»ï¼šåŸç‚¹åœ¨å·¦ä¸‹è§’
                newPage.drawPage(embeddedPage, {
                    x: -region.rect.x,
                    y: -region.rect.y,
                    width: pageWidth,
                    height: pageHeight
                });
                
                console.log(`åŒºåŸŸ ${i + 1} å¤„ç†å®Œæˆ`);
            }

            // ä¿å­˜PDF
            mergedPdfBytes = await newPdf.save();
            console.log('PDFåˆå¹¶å®Œæˆï¼Œå¤§å°:', mergedPdfBytes.length, 'bytes');

            // æ˜¾ç¤ºé¢„è§ˆ
            await showPreview(mergedPdfBytes);
            
        } catch (error) {
            console.error('åˆå¹¶PDFå¤±è´¥:', error);
            console.error('é”™è¯¯å †æ ˆ:', error.stack);
            alert('åˆå¹¶PDFå¤±è´¥: ' + error.message);
        }
    });

    async function showPreview(pdfData) {
        const previewContainer = document.getElementById('preview-pages-container');
        previewContainer.innerHTML = '<p>æ­£åœ¨åŠ è½½é¢„è§ˆ...</p>';
        document.getElementById('preview-modal').style.display = 'flex';

        try {
            // ä½¿ç”¨PDF.jsæ¸²æŸ“é¢„è§ˆ
            const loadingTask = pdfjsLib.getDocument({data: pdfData});
            const pdf = await loadingTask.promise;
            
            previewContainer.innerHTML = '';
            
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({scale: 1.5});
                
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                const context = canvas.getContext('2d');
                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;
                
                const pageTitle = document.createElement('div');
                pageTitle.textContent = `ç¬¬ ${pageNum} é¡µ`;
                pageTitle.style.cssText = 'margin: 10px 0; font-weight: bold; color: #333;';
                
                previewContainer.appendChild(pageTitle);
                previewContainer.appendChild(canvas);
            }
        } catch (error) {
            console.error('é¢„è§ˆPDFå¤±è´¥:', error);
            previewContainer.innerHTML = '<p style="color: red;">é¢„è§ˆå¤±è´¥: ' + error.message + '</p>';
        }
    }

    function closePreview() {
        document.getElementById('preview-modal').style.display = 'none';
    }

    function downloadPDF() {
        if (!mergedPdfBytes) {
            alert('æ²¡æœ‰å¯ä¸‹è½½çš„PDF');
            return;
        }

        const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        let filename = document.getElementById('filename-input').value || 'merged_document';
        if (!filename.toLowerCase().endsWith('.pdf')) filename += '.pdf';
        
        link.download = filename;
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);
    }

    // ================= çŠ¶æ€ä¿å­˜å’Œæ¢å¤ =================
    
    const DB_NAME = 'pdfToolDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'pdfFiles';
    
    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME);
                }
            };
        });
    }
    
    async function savePDFToDB(pdfData) {
        try {
            const db = await openDB();
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            return new Promise((resolve, reject) => {
                const request = store.put(pdfData, 'currentPDF');
                request.onsuccess = () => {
                    console.log('PDFæ–‡ä»¶å·²ä¿å­˜åˆ°IndexedDB');
                    resolve();
                };
                request.onerror = () => reject(request.error);
            });
        } catch (e) {
            console.error('ä¿å­˜PDFåˆ°IndexedDBå¤±è´¥:', e);
        }
    }
    
    async function loadPDFFromDB() {
        try {
            const db = await openDB();
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get('currentPDF');
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        } catch (e) {
            console.error('ä»IndexedDBåŠ è½½PDFå¤±è´¥:', e);
            return null;
        }
    }
    
    function savePDFToolState() {
        if (!pdfDoc) return;
        
        const state = {
            pageNum: pageNum,
            scale: scale,
            capturedRegions: capturedRegions.map(r => ({
                pageNum: r.pageNum,
                rect: r.rect,
                displayRect: r.displayRect,
                previewDataUrl: r.previewCanvas.toDataURL()
            })),
            isXLocked: isXLocked,
            isCropBoxInitialized: isCropBoxInitialized,
            cropBoxVisible: cropBox.style.display === 'block',
            cropBoxPosition: cropBox.style.display === 'block' ? {
                left: cropBox.style.left,
                top: cropBox.style.top,
                width: cropBox.style.width,
                height: cropBox.style.height
            } : null
        };
        
        sessionStorage.setItem('pdfToolState', JSON.stringify(state));
    }
    
    async function restorePDFToolState() {
        if (!pdfDoc) return false;
        
        const stateStr = sessionStorage.getItem('pdfToolState');
        if (!stateStr) return false;
        
        try {
            const state = JSON.parse(stateStr);
            
            if (state.pageNum) {
                pageNum = state.pageNum;
                document.getElementById('page-num').textContent = `${pageNum} / ${pdfDoc.numPages}`;
                renderPage(pageNum);
            }
            if (state.scale) {
                scale = state.scale;
                document.getElementById('zoom-level').innerText = Math.round(scale * 100) + '%';
            }
            
            if (state.capturedRegions && state.capturedRegions.length > 0) {
                capturedRegions = state.capturedRegions.map(r => {
                    const canvas = document.createElement('canvas');
                    const img = new Image();
                    img.src = r.previewDataUrl;
                    img.onload = () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        canvas.getContext('2d').drawImage(img, 0, 0);
                    };
                    return {
                        pageNum: r.pageNum,
                        rect: r.rect,
                        displayRect: r.displayRect,
                        previewCanvas: canvas
                    };
                });
                updateCapturedList();
            }
            
            if (state.isCropBoxInitialized) {
                isCropBoxInitialized = state.isCropBoxInitialized;
            }
            if (state.isXLocked !== undefined) {
                isXLocked = state.isXLocked;
                updateLockButtonText();
            }
            
            if (state.cropBoxPosition) {
                cropBox.style.left = state.cropBoxPosition.left;
                cropBox.style.top = state.cropBoxPosition.top;
                cropBox.style.width = state.cropBoxPosition.width;
                cropBox.style.height = state.cropBoxPosition.height;
                cropBox.style.display = state.cropBoxVisible ? 'block' : 'none';
                updateHandleVisibility();
                
                const cropBtn = document.getElementById('init-crop');
                if (cropBtn) {
                    cropBtn.style.backgroundColor = state.cropBoxVisible ? '#28a745' : '#007bff';
                }
            }
            
            return true;
        } catch (e) {
            console.error('æ¢å¤PDFå·¥å…·çŠ¶æ€å¤±è´¥:', e);
            return false;
        }
    }
    
    // æ–‡ä»¶ä¸Šä¼ 
    const fileInput = document.getElementById('file-input');
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file.type !== 'application/pdf') {
            alert('è¯·é€‰æ‹© PDF æ–‡ä»¶');
            return;
        }
        
        if (isAutoPaging) {
            document.getElementById('auto-page-toggle').click();
        }
        
        const fileReader = new FileReader();
        fileReader.onload = async function() {
            const typedarray = new Uint8Array(this.result);
            pdfBytes = typedarray; // ä¿å­˜åŸå§‹PDFæ•°æ®
            
            await savePDFToDB(typedarray);
            
            pdfjsLib.getDocument(typedarray).promise.then(function(pdfDoc_) {
                pdfDoc = pdfDoc_;
                pageNum = 1;
                document.getElementById('page-num').textContent = `${pageNum} / ${pdfDoc.numPages}`;
                renderPage(pageNum);
                
                const cropBtn = document.getElementById('init-crop');
                cropBox.style.display = 'none';
                isCropBoxInitialized = false;
                cropBtn.style.backgroundColor = '#007bff';
                
                setTimeout(() => {
                    restorePDFToolState();
                }, 500);
            });
        };
        fileReader.readAsArrayBuffer(file);
    });
    
    setInterval(savePDFToolState, 3000);
    
    const originalCaptureSelectedArea = captureSelectedArea;
    captureSelectedArea = function() {
        originalCaptureSelectedArea();
        savePDFToolState();
    };

    // è·³è½¬åˆ°BBoxå·¥å…·é¡µé¢
    document.getElementById('bbox-tool-btn').addEventListener('click', function() {
        savePDFToolState();
        window.location.href = '../pdf_stitcher/bbox_tool.html';
    });

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¢å¤
    window.addEventListener('DOMContentLoaded', async function() {
        const cachedPdfData = await loadPDFFromDB();
        if (cachedPdfData) {
            try {
                pdfBytes = cachedPdfData;
                pdfjsLib.getDocument(cachedPdfData).promise.then(function(pdfDoc_) {
                    pdfDoc = pdfDoc_;
                    document.getElementById('page-num').textContent = `${pageNum} / ${pdfDoc.numPages}`;
                    renderPage(pageNum);
                    
                    setTimeout(() => {
                        restorePDFToolState();
                    }, 500);
                });
            } catch (e) {
                console.error('ä»ç¼“å­˜æ¢å¤PDFå¤±è´¥:', e);
            }
        }
    });

</script>
</body>
</html>

